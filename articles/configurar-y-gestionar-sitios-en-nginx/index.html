<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Configurar y gestionar sitios en Nginx I - Jonathan Alvarez</title><meta name="description" content="Web Developer highly specialized in frontend Techologies, JavaScript applications, CSS and React. Design enthusiast."><link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="Jonathan Álvarez González is a frontend developer from Colombia. In this site you will find articles and thoughts about web development"><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🦑</text></svg>">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/utilities.css"><link media="(prefers-color-scheme: dark)" rel="stylesheet" href="/css/dark.css"></head><body class="article"><div class="wrap"><article class="content content--extend"><header class="article-header default-wrap"><div class="article-inner"><nav class="article-author"><a href="/" title="Go home">Jonathan Alvarez</a></nav><h1 class="article-title">Configurar y gestionar sitios en Nginx I</h1><div class="article-meta"><span>January 24th 2014</span></div></div></header><section class="article-content default-wrap"><p><em>¿Así que quieres/debes abandonar tu querido servidor Apache con CPanel, te pasas a Nginx y no sabes cómo<span class="widont">&nbsp;</span>empezar?</em></p>
<p>Aunque al principio Nginx paresca confuso, verás que es estúpidamente simple y flexible. <em>Además de<span class="widont">&nbsp;</span>rápido.</em></p>
<p>Lo que muestro a continuación es la forma más recomendada y pro de mantener tus sitios en orden en<span class="widont">&nbsp;</span>Nginx.</p>
<blockquote>
<p>Las ubicaciones pueden variar de acuerdo a la distribución linux utilizada. Se muestran como ejemplo en<span class="widont">&nbsp;</span>Archlinux</p>
</blockquote>
<p>Lo primero es darle una configuración básica a<span class="widont">&nbsp;</span>Nginx.</p>
<p>Reemplaza el contenido del archivo <code>/etc/nginx/nginx.conf</code> por:</p>
<pre><code># https://github.com/perusio/wordpress-nginx

user http;
worker_processes 1;

error_log logs/error.log;
#error_log logs/error.log notice;
#error_log logs/error.log info;

#pid logs/nginx.pid;

events {
    worker_connections 2048;
    # optmized to serve many clients with each thread, essential for linux Accept as many connections as possible.
    use epoll;

    # Accept as many connections as possible.
    multi_accept on;
}
http {

    include mime.types;
    default_type application/octet-stream;
    server_names_hash_bucket_size 64;

    #log_format main &#39;$remote_addr - $remote_user [$time_local] \&quot;$request\&quot; &#39;
    #                  &#39;$status $body_bytes_sent \&quot;$http_referer\&quot; &#39; &#39;\&quot;$http_user_agent\&quot; \&quot;$http_x_forwarded_for\&quot;&#39;; access_log
    #off;
    ## FastCGI.
    include /etc/nginx/fastcgi.conf;

    ## Use sendfile() syscall to speed up I/O operations and speed up static file serving.}
    sendfile on;

    ## Handling of IPs in proxied and load balancing situations.
    #set_real_ip_from 0.0.0.0/32; # all addresses get a real IP. real_ip_header X-Forwarded-For; # the ip is forwarded from the
    #load balancer/proxy

    ## Define a zone for limiting the number of simultaneous connections nginx accepts. 1m means 32000 simultaneous sessions.
    ## We need to define for each server the limit_conn value refering to this or other zones. ** This syntax requires nginx
    ## version &gt;= ** 1.1.8. Cf. http://nginx.org/en/CHANGES. If using an older ** version then use the limit_zone directive
    ## below ** instead. Comment out this ** one if not using nginx version &gt;= 1.1.8.
    limit_conn_zone $binary_remote_addr zone=arbeit:10m;

    ## Define a zone for limiting the number of simultaneous connections nginx accepts. 1m means 32000 simultaneous sessions.
    ## We need to define for each server the limit_conn value refering to this or other zones. ** Use this directive for nginx
    ## versions below 1.1.8. Uncomment the line below.
    #limit_zone arbeit $binary_remote_addr 10m;

    ## Timeouts.
    client_body_timeout 60;
    client_header_timeout 60;
    keepalive_timeout 10 10;
    send_timeout 60;

    ## Reset lingering timed out connections. Deflect DDoS.
    reset_timedout_connection on;

    ## Body size.
    client_max_body_size 10m;

    ## TCP options.
    tcp_nodelay on;

    ## Optimization of socket handling when using sendfile.
    tcp_nopush on;

    ## Compression.
    gzip on;
    gzip_buffers 16 8k;
    gzip_comp_level 1;
    gzip_http_version 1.1;
    gzip_min_length 10;
    gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript image/x-icon application/vnd.ms-fontobject font/opentype application/x-font-ttf;
    gzip_vary on;
    gzip_proxied any; # Compression for all requests.

    ## No need for regexps. See http://wiki.nginx.org/NginxHttpGzipModule#gzip_disable
    gzip_disable \&quot;msie6\&quot;;

    ## Serve already compressed files directly, bypassing on-the-fly compression.
    gzip_static on;

    ## Hide the Nginx version number.
    server_tokens off;

    ## Use a SSL/TLS cache for SSL session resume. This needs to be here (in this context, for session resumption to work. See
    ## this thread on the Nginx mailing list: http://nginx.org/pipermail/nginx/2010-November/023736.html.
    #ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m;

    ## Enable clickjacking protection in modern browsers. Available in IE8 also. See
    ## https://developer.mozilla.org/en/The_X-FRAME-OPTIONS_response_header
    add_header X-Frame-Options sameorigin;

    ## Include the upstream servers for PHP FastCGI handling config.
    #include upstream_phpcgi.conf;

    ## Include the upstream servers for Apache handling the PHP processes. In this case Nginx functions as a reverse proxy.
    #include reverse_proxy.conf; include upstream_phpapache.conf;
    ## Include the php-fpm status allowed hosts configuration block. Uncomment to enable if you&#39;re running php-fpm.
    #include php_fpm_status_allowed_hosts.conf;
    ## Include blacklist for bad bot and referer blocking.
    #include blacklist.conf;

    ## Include all vhosts.
    include /etc/nginx/sites-enabled/*;
}</code></pre><p><em>Calm down. Es algo genérico y funcionará con cualquier<span class="widont">&nbsp;</span>sitio.</em></p>
<p>Sólo debes asegurarte que el usuario que utilices sea el que realmente emplea tu servidor, en Archlinux es <code>http</code>, otras distribuciones familia Debian como Ubuntu, utilizan <code>www-data</code>.</p>
<h2 id="hora-de-modular">Hora de modular</h2>
<p>Ahora, creemos archivos de configuración para utilizarlos como módulos e incluirlos sólo en los sitios que queramos. Como por ejemplo para <code>php</code>, controles de seguridad, manejo de archivos estáticos comúnes y el que<span class="widont">&nbsp;</span>necesites.</p>
<pre><code>cd /etc/nginx/
mkdir -p global</code></pre><p>Algunas restricciones para archivos comunes <code>/etc/nginx/global/drop.conf</code></p>
<pre><code># http://centminmod.com/nginx_configure_wordpress.html
location = /robots.txt { access_log off; log_not_found off; }
location = /favicon.ico { access_log off; log_not_found off; expires 30d; }
location ~ /\.  { access_log off; log_not_found off; deny all; }
location ~ ~$ { access_log off; log_not_found off; deny all; }
location ~ /\.git { access_log off; log_not_found off; deny all; }</code></pre><p>Algunos controles de seguridad <code>/etc/nginx/global/sec.conf</code></p>
<pre><code>## http://centminmod.com/nginx_configure_wordpress.html
# Deny access to any files with a .php extension in the uploads directory Works in sub-directory installs and also in multisite
# network
location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
}
# Make sure files with the following extensions do not get loaded by nginx because nginx would display the source code, and
# these files can contain PASSWORDS!
location ~* \.(engine|inc|info|install|make|module|profile|test|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$|^(\..*|Entries.*|Repository|Root|Tag|Template)$|\.php_  {
    return 444;
}
#nocgi
location ~* \.(pl|cgi|py|sh|lua)\$ {
    return 444;
}
#disallow
location ~* (roundcube|webdav|smtp|http\:|soap|w00tw00t) {
    return 444;
}
location ~ /(\.|wp-config.php|readme.html|license.txt) { deny all; }</code></pre><p>Y este último para <code>php-fpm</code> en <code>/etc/nginx/global/php.conf</code></p>
<pre><code># PHP FastCGI config
location ~ \.php$ {
    try_files $uri = 404;
    # socket
    fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;
    fastcgi_index index.php;
    include fastcgi.conf;
}</code></pre><p>Podemos verificar la sintaxis y estado ejecutando <code>nginx -t</code> si recibimos un error, tal vez escribiste algo<span class="widont">&nbsp;</span>mal.</p>
<p>Ahora continua <a href="http://blog.jonalvarezz.com/configurar-y-gestionar-sitios-en-nginx-ii/">creando cada configuración específica para cada<span class="widont">&nbsp;</span>sitio</a>.</p>
</section><aside class="article-share text-center default-wrap"><hr><a href="https://twitter.com/share?text=Configurar%20y%20gestionar%20sitios%20en%20Nginx%20I by @jonalvarezz&amp;url=" title="Share on Twitter" onclick="this.href+=window.location.href; window.open(this.href, 'twitter-share', 'width=550,height=330');return false;"><i class="fa fa-twitter"></i></a><a href="https://www.facebook.com/sharer/sharer.php?u=" title="Share on Facebook" onclick="this.href+=window.location.href; window.open(this.href, 'facebook-share', 'width=580,height=330');return false;"><i class="fa fa-facebook"></i></a></aside><footer class="footer-article"><div class="default-wrap"><nav class="article-pagination grid grid--vertical-align"><div class="prev grid-item grid-item--half text-left"><div><small>PREV</small></div><a href="/articles/configurar-y-gestionar-sitios-en-nginx-ii/">Configurar  y gestionar sitios en Nginx II</a></div><div class="next grid-item grid-item--half text-right"><div><small>NEXT</small></div><a href="/articles/crear-menus-de-navegacion-administrativos-en-wordpress/">Crear Menús Administrativos en Wordpress</a></div></nav><div class="footer-colophon text-center"><small><a href="/" title="Go home">JONATHAN ALVAREZ</a></small></div></div></footer></article></div><script type="module" src="/scripts/main.js"></script><script>WebFontConfig = {
  google: { families: [ 'Merriweather:400,900:latin', 'Source+Sans+Pro:700' ] }
};
(function() {
  var wf = document.createElement('script');
  wf.src = 'https://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
  wf.type = 'text/javascript';
  wf.async = 'true';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(wf, s);
})()</script></body></html>